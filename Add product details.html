<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Products — Add & View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="image/logo/Logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" 
  rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <h1>Add Product</h1>

  <form id="productForm" autocomplete="off">
    <div>
      <label for="provider_id">Provider ID *</label>
      <input type="number" id="provider_id" name="provider_id" required />
    </div>

    <div>
      <label for="product_name">Product Name *</label>
      <input type="text" id="product_name" name="product_name" required maxlength="255" />
    </div>

    <div>
      <label for="product_description">Description</label>
      <textarea id="product_description" name="product_description" rows="4"></textarea>
    </div>

    <div>
      <label for="price">Price (e.g. 1999.99) *</label>
      <input type="number" id="price" name="price" required step="0.01" min="0" />
    </div>

    <div>
      <label for="stock_quantity">Stock Quantity *</label>
      <input type="number" id="stock_quantity" name="stock_quantity" required min="0" />
    </div>

    <div>
      <label for="category">Category</label>
      <input type="text" id="category" name="category" maxlength="100" />
    </div>

    <button type="submit">Save Product</button>
  </form>

  <div id="status" role="status" aria-live="polite"></div>

  <hr />

  <h2>Products (Newest first)</h2>
  <button id="refreshBtn" type="button">Refresh</button>
  <table id="productsTable" border="1" cellspacing="0" cellpadding="6">
    <thead>
      <tr>
        <th>product_id</th>
        <th>provider_id</th>
        <th>product_name</th>
        <th>product_description</th>
        <th>price</th>
        <th>stock_quantity</th>
        <th>category</th>
        <th>created_at</th>
        <th>updated_at</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById('productForm');
    const statusEl = document.getElementById('status');
    const tableBody = document.querySelector('#productsTable tbody');
    const refreshBtn = document.getElementById('refreshBtn');

    async function fetchProducts() {
      try {
        const res = await fetch('api/get_products.php', { cache: 'no-store' });
        const data = await res.json();
        renderRows(data.products || []);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Failed to load products.';
      }
    }

    function renderRows(products) {
      tableBody.innerHTML = '';
      for (const p of products) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.product_id}</td>
          <td>${p.provider_id}</td>
          <td>${escapeHtml(p.product_name)}</td>
          <td>${escapeHtml(p.product_description || '')}</td>
          <td>${p.price}</td>
          <td>${p.stock_quantity}</td>
          <td>${escapeHtml(p.category || '')}</td>
          <td>${p.created_at}</td>
          <td>${p.updated_at}</td>
        `;
        tableBody.appendChild(tr);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Saving...';

      const payload = {
        provider_id: Number(document.getElementById('provider_id').value),
        product_name: document.getElementById('product_name').value.trim(),
        product_description: document.getElementById('product_description').value.trim(),
        price: document.getElementById('price').value,
        stock_quantity: Number(document.getElementById('stock_quantity').value),
        category: document.getElementById('category').value.trim()
      };

      try {
        const res = await fetch('api/add_product.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.success) {
          statusEl.textContent = 'Product saved.';
          form.reset();
          await fetchProducts(); // refresh table so it stays in sync
        } else {
          statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network or server error.';
      }
    });

    refreshBtn.addEventListener('click', fetchProducts);

    // Initial load + optional periodic refresh to keep “synced”
    fetchProducts();
    // setInterval(fetchProducts, 10000); // uncomment to auto-refresh every 10s
  </script>
</body>
</html>
